---
title: "Life hist stats attempts anova, glm, prob test"
author: "Virginia Chu"
date: "October 19, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd("C:/Users/vmc04/Documents/GitHub/wingproj/lifehist")
lifehistshort<-read.csv("2017_10_18 Life history shortened.csv", header=TRUE)
lifehistshort$Locality=factor(lifehistshort$Locality, c("ARS","APR","RPV","RMO","TLC","TPN","SJU"))
lifehistshort$Lat_group=factor(lifehistshort$Lat_group, c(1,2,3))

library(dplyr)
library(lme4)

##nested design in r
boxplot(AdRate~Temp_let, data=lifehistshort)
boxplot(AdRate~Biome, data=lifehistshort)
boxplot(AdRate~Locality, data=lifehistshort)

dotplot(AdRate~Locality|Biome, data=lifehistshort)

res1<-lm(AdRate~ Biome + Biome/Locality, data=lifehistshort)
anova(res1)
TukeyHSD(aov(res1), "Biome")
TukeyHSD(aov(res1), "Biome:Locality")

## effect of temp on proportion surviving by sex and location
lifetot<-read.csv("2017_10_19 Life hist totals for proportion  survived from temp.csv", header=TRUE)
lifetot$Total<-lifetot$Female+lifetot$Male+lifetot$Died
lifetot$PerFem<-lifetot$Female/lifetot$Total
lifetot$PerMal<-lifetot$Male/lifetot$Total
lifetot$Alive<-lifetot$Male+lifetot$Female

table( lifehistshort$Temp_let, lifehistshort$Sex1)
prop.test(table(lifehistshort$Temp_let, lifehistshort$Sex1), correct=FALSE)
#prop.test(table(lifehistshort$Temp_num, lifehistshort$Sex1), correct=FALSE)

table( lifehistshort$Locality, lifehistshort$Sex1)
prop.test(table(lifehistshort$Locality, lifehistshort$Sex1), correct=FALSE)

#library(MASS)
#survtab<-xtabs(Death_stat~Locality+Temp_let, data=lifehistshort)
#loglm(~Locality+Temp_let,survtab)

library(gmodels)
#make separate table
lifecont<-subset(lifehistshort, select=c(5,7,17) )
#CrossTable(lifehistshort$Death_stat, lifehistshort$Temp_let, chisq=TRUE)
#CrossTable(lifetot$Locality, lifetot$Temp, chisq=TRUE)

###WORKS FOR 3 WAY CONTINGENCY
lifecont1<-read.csv("2017_10_19 Life hist totals for proportion  survived from temp1.csv",header=TRUE)
class(lifecont1)
library(dplyr)
### Specify the order of factor levels
### Otherwise, R will alphabetize them
data=mutate(lifecont1, Locality=factor(Locality, levels=unique(Locality)),
            Temperature=factor(Temperature, levels=unique(Temperature)),
            Status=factor(Status, levels=unique(Status)))

data.xtabs=xtabs(Count~Locality+Temperature+Status, data=data)
ftable(data.xtabs)
mantelhaen.test(data.xtabs)

lifecont2<-lifecont1
lifecont2$Biome= ifelse(lifecont2$Locality=="ARS" | "APR", "Amazon", "Mata Atlantica")      
data=mutate(lifecont1, Locality=factor(Locality, levels=unique(Locality)),
            Temperature=factor(Temperature, levels=unique(Temperature)),
            Status=factor(Status, levels=unique(Status)))

data.xtabs=xtabs(Count~Locality+Temperature+Status, data=data)
ftable(data.xtabs)
mantelhaen.test(data.xtabs)
#ind fisher exact tests
#n=dim(data.xtabs)[3]
#for(i in 1:n){
#   Name = dimnames(data.xtabs)[3]$Locality[i]
#   P.value = fisher.test(data.xtabs[,,i])$p.value
#   cat(Name, "\n")
#   cat("Fisher test p-value: ", P.value, "\n")
#   cat("\n")
#  } #insufficient workspace even at 2e6




##glmm
#from Nakagawa et al 2013

shapiro.test(survive$AdRate)
shapiro.test(survive$Wing.length..mm.)
#not normally distributed

# Fit null model without fixed effects (but including all random effects)
mod_adrate0<-lmer(AdRate~1+(1|Biome)+(1|State), family=binomial, data=lifehistshort)
mod_adrate1<-lmer(AdRate~1+(1|Biome)+(1|State), family=binomial, data=lifehistshort,na.action=na.omit)
mod_adrateF1<-lmer(AdRate~Temp_let+Locality+(1|Biome)+(1|State), family=binomial, data=lifehistshort)
mod_adrateF2<-lmer(AdRate~Temp_let+Locality+(1|Biome)+(1|State), family=binomial, data=lifehistshort, na.action=na.omit)
summary(mod_adrate0)
modadrate<-AIC(mod_adrate0, mod_adrate1, mod_adrateF1, mod_adrateF2)
modadrate

##different distribution?
mod_adrate01<-glm(AdRate~1+(1|Biome)+(1|State), family=binomial(logit), data=lifehistshort)
mod_adrate11<-glm(AdRate~1+(1|Biome)+(1|State), family=binomial(logit), data=lifehistshort,na.action=na.omit)
mod_adrateF11<-glm(AdRate~Temp_let+Locality+(1|Biome)+(1|State), family=binomial(logit), data=lifehistshort)
mod_adrateF21<-glm(AdRate~Temp_let+Locality+(1|Biome)+(1|State), family=binomial(logit), data=lifehistshort, na.action=na.omit)
summary(mod_adrate01)
modadrate1<-AIC(mod_adrate01, mod_adrate11, mod_adrateF11, mod_adrateF21)
modadrate1

##body size
#null
mod_wing0<-lmer(Wing.length..mm.~1+(1|Biome)+(1|State), data=lifehistshort)
summary(mod_wing0)
#full
mod_wingf<-lmer(Wing.length..mm.~Sex+Temp_let+Locality+(1|Biome)+(1|State), data=lifehistshort)
summary(mod_wingf)

# AIC and BIC needs to be calcualted with ML not REML in body size models
m0wing <- lmer(Wing.length..mm.~1+(1|Biome)+(1|State), data = lifehistshort, REML = FALSE)
m01wing <- lmer(Wing.length..mm.~1+(1|Biome)+(1|State), data = lifehistshort, REML = FALSE, na.action=na.omit)
m02wing <- lmer(Wing.length..mm.~1+(1|Biome)+(1|State), data = lifehistshort, REML = FALSE, na.action=na.exclude)
m1wing <- lmer(Wing.length..mm.~Temp_let+(1|Biome)+(1|State), data = lifehistshort, REML = FALSE)
m2wing <- lmer(Wing.length..mm.~Temp_let+Locality+(1|Biome)+(1|State), data = lifehistshort, REML = FALSE)
mFwing <- lmer(Wing.length..mm.~Sex+Temp_let+Locality+(1|Biome)+(1|State), data = lifehistshort, REML = FALSE)

summary(m0wing)
summary(m01wing)
modelnaomit<-AIC(m0wing, m01wing,m02wing)
summary(mFwing)
model_wingAIC<-AIC(m0wing,m1wing,m2wing,mFwing)
print(model_wingAIC)

Data <- read.csv("mee3261-sup-0001-DataS1.csv")
m0 <- lmer(BodyL ~ 1 + (1 | Population) + (1 | Container), data = Data)

# Fit alternative model including fixed and all random effects
mF <- lmer(BodyL ~ Sex + Treatment + Habitat + (1 | Population) + (1 | Container), data = Data)

# View model fits for both models
summary(m0)
summary(mF)
m0ML <- lmer(BodyL ~ 1 + (1 | Population) + (1 | Container), data = Data, REML = FALSE)
mFML <- lmer(BodyL ~ Sex + Treatment + Habitat + (1 | Population) + (1 | Container), data = Data, REML = FALSE)

# View model fits for both models fitted by ML
summary(m0ML)
summary(mFML)



#*#*#*#Time to emergence
# Two Way Factorial Design 
#fit <- aov(y ~ A + B + A:B, data=mydataframe)
#fit <- aov(y ~ A*B, data=mydataframe) # same thing
# Analysis of Covariance 
#fit <- aov(y ~ A + x, data=mydataframe)
survive<- subset(lifehistshort, !is.na(Sex1), c=(1:25))
shapiro.test(survive$Emtime)
#not normal, use nonparametric test
em_fit1g<-glmer(Emtime~Lat_group+(1|Biome)+Temp_let, data=survive, family=poisson)
summary(em_fit1g)

em_fit2g<-glmer(Emtime~Lat_group+(1|Biome)+(1|Family)+Temp_let, data=survive, family=poisson)
summary(em_fit2g)

em_fit3g<-glmer(Emtime~Lat_group+(1|Biome)+(1|State)+Temp_let, data=survive, family=poisson)
summary(em_fit3g)

em_fit4g<-glmer(Emtime~(1|Biome)+Lat_group*Temp_let, data=survive, family=poisson)
summary(em_fit4g)
emfitg_mod<-AIC(em_fit1g, em_fit2g, em_fit3g, em_fit4g)

emfit1<-glm(Emtime~Temp_let, data=survive, family=poisson)
emfit2<-glm(Emtime~Lat_group, data=survive, family=poisson)
emfit3<-glm(Emtime~Lat_group+Temp_let, data=survive, family=poisson)
emfit4<-glm(Emtime~Lat_group*Temp_let, data=survive, family=poisson)
emfit_mod<-AIC(emfit1, emfit2, emfit3, emfit4)

emfit1c<-glm(Emtime~Temp_num, data=survive, family=poisson)
emfit2c<-glm(Emtime~Lat_group, data=survive, family=poisson)
emfit3c<-glm(Emtime~Lat_group+Temp_num, data=survive, family=poisson)
emfit4c<-glm(Emtime~Lat_group*Temp_num, data=survive, family=poisson)
emfit_modc<-AIC(emfit1c, emfit2c, emfit3c, emfit4c)

#emtime data
emtime_avg<-aggregate(survive$Emtime, list(Locality= survive$Locality, Sex=survive$Sex, Temperature=survive$Temp_num), mean)
write.table(emtime_avg, "clipboard", sep='\t')
emtime_sd<-aggregate(survive$Emtime, list(Locality= survive$Locality, Sex=survive$Sex, Temperature=survive$Temp_num), sd)
write.table(emtime_sd, "clipboard", sep='\t')

emtime_avg1<-aggregate(survive$Emtime, list(Latitude= survive$Lat_group, Sex=survive$Sex, Temperature=survive$Temp_num), mean)
write.table(emtime_avg1, "clipboard", sep='\t')
emtime_sd1<-aggregate(survive$Emtime, list(Latitude= survive$Lat_group, Sex=survive$Sex, Temperature=survive$Temp_num), sd)
write.table(emtime_sd1, "clipboard", sep='\t')

emtime_avg2<-aggregate(survive$Emtime, list(Latitude= survive$Lat_group, Temperature=survive$Temp_num), mean)
write.table(emtime_avg2, "clipboard", sep='\t')
emtime_sd2<-aggregate(survive$Emtime, list(Latitude= survive$Lat_group, Temperature=survive$Temp_num), sd)
write.table(emtime_sd2, "clipboard", sep='\t')

##lsmeans on categorical (temp let and locality)
library(lsmeans)
em_post<-cld(lsmeans(emfit3, "Lat_group",adjust="tukey"))
em_post1g<-cld(lsmeans(em_fit1g, "Lat_group", adjust="tukey"))
em_post2<-cld(lsmeans(emfit3, "Temp_let",adjust="tukey"))


##&#&#&# ANCOVA on EMTIME
em_anc<-lm(Emtime~Lat_group*Temp_let, data=survive)
summary(em_anc)
em_ancls<-cld(lsmeans(em_anc, c("Lat_group", "Temp_let")))

survivef<-subset(survive, Sex=="F", c(1:25))
survivem<-subset(survive, Sex=="M", c(1:25))

em_ancf<-lm(Emtime~Lat_group*Temp_let, data=survivef)
summary(em_ancf)
em_anclsf<-cld(lsmeans(em_ancf, c("Lat_group", "Temp_let")))

em_ancm<-lm(Emtime~Lat_group*Temp_let, data=survivem)
summary(em_ancm)
em_anclsm<-cld(lsmeans(em_ancm, c("Lat_group", "Temp_let")))

em_ancal<-lm(Emtime~Lat_group*Temp_let*Sex, data=survive)
summary(em_ancal)
em_anclsal<-cld(lsmeans(em_ancal, c("Lat_group", "Temp_let", "Sex")))


```

## R Markdown

Proportion- http://www.r-tutor.com/elementary-statistics/inference-about-two-populations/comparison-two-population-proportions
Cochran-mantel-haenszel-https://rcompanion.org/rcompanion/b_10.html

ANCOVA lsmeans tutorial-http://rstudio-pubs-static.s3.amazonaws.com/22877_056e76459d274dd6bc9158433aff35ef.html

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
